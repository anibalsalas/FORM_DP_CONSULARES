<form [formGroup]="ficha7Form" (ngSubmit)="guardarSeccion7()" class="container-fluid form-seccion7">

  <section class="acciones">
    <button class="gridSaveItem" mat-stroked-button  type="button" (click)="guardarSeccion7Incompleta()">
            Guardado Parcial
          </button>
    
      <button mat-flat-button class="gridSaveItemC" type="submit">
        Guardar como Completa
      </button>
    
      <button *ngIf="tieneRolEspecialista()" mat-flat-button class="gridSaveItemC" type="button" (click)="validarSeccion()">
        Validar sección
      </button>
    
    </section>
<section class="card">

  <!-- 7.1 -->
  <div class="q">
    <label class="q-label">7.1 ¿Se requiere cita previa para acudir al consulado a realizar dicho trámite?</label>
    <mat-radio-group formControlName="p71Requiere" class="inline">
      <mat-radio-button value="S">Sí <b style="color:#0094ea;"> → Pase a 7.2</b></mat-radio-button>
      <mat-radio-button value="N">No <b style="color:#0094ea;"> → Pase a 7.3</b></mat-radio-button>
    </mat-radio-group>
    <div class="err" *ngIf="isInvalid('p71Requiere')">Requerido</div>
  </div>

  <!-- 7.2 -->
  <div class="q sub">
    <label class="q-label">7.2 De ser afirmativa, indicar el tiempo promedio entre el pedido de cita y la atención</label>
    <mat-radio-group formControlName="p72Afirmativa" class="inline">
      <mat-radio-button value="A">01 día</mat-radio-button>
      <mat-radio-button value="B">02–04 días</mat-radio-button>
      <mat-radio-button value="C">05–10 días</mat-radio-button>
      <mat-radio-button value="D">11–15 días</mat-radio-button>
      <mat-radio-button value="E">16 días o más</mat-radio-button>
    </mat-radio-group>
        <div class="err" *ngIf="isInvalid('p72Afirmativa')">Requerido</div>

  </div>

  <!-- 7.3 A - Solicitadas/Otorgadas/Denegadas -->
  <div class="q">
    <label class="q-label">7.3 Respecto al procedimiento de expedición de visas</label>

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-secondary align-middle" style="font-size:.9rem; color: #013a4c;">
          <tr>
            <th>Año</th>
            <th colspan="3">N° de visas solicitadas</th>
            <th colspan="3">N° de visas otorgadas</th>
            <th colspan="3">N° de visas denegadas</th>
          </tr>
          <tr>
            <th></th>
            <th>Hombres</th><th>Mujeres</th><th>Menores</th>
            <th>Hombres</th><th>Mujeres</th><th>Menores</th>
            <th>Hombres</th><th>Mujeres</th><th>Menores</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>2023</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023SoliciHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023SoliciMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023SoliciMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023OtorgaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023OtorgaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023OtorgaMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023DenegaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023DenegaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023DenegaMenores"></td>
          </tr>

          <tr>
            <td>2024</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024SoliciHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024SoliciMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024SoliciMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024OtorgaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024OtorgaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024OtorgaMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024DenegaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024DenegaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024DenegaMenores"></td>
          </tr>

          <tr>
            <td>2025</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025SoliciHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025SoliciMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025SoliciMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025OtorgaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025OtorgaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025OtorgaMenores"></td>

            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025DenegaHombre"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025DenegaMujer"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025DenegaMenores"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 7.3 B - N° otorgadas por calidad migratoria -->
  <div class="q">
    <label class="q-label">Indicar el N° de visas otorgadas por calidad migratoria</label>

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-secondary align-middle" style="font-size:.9rem; color: #013a4c !important;">
          <tr>
            <th>Calidad migratoria</th>
            <th>2023</th>
            <th>2024</th>
            <th>2025</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Oficial</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumOficial"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumOficial"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumOficial"></td>
          </tr>
          <tr>
            <td>Diplomática</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumDiplomatica"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumDiplomatica"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumDiplomatica"></td>
          </tr>
          <tr>
            <td>Consular</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumConsular"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumConsular"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumConsular"></td>
          </tr>
          <tr>
            <td>Negocios</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumNegocios"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumNegocios"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumNegocios"></td>
          </tr>
          <tr>
            <td>Turista</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumTurista"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumTurista"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumTurista"></td>
          </tr>
          <tr>
            <td>Cooperante</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumCooperante"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumCooperante"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumCooperante"></td>
          </tr>
          <tr>
            <td>Intercambio</td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumIntercambio"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumIntercambio"></td>
            <td><input class="form-control" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumIntercambio"></td>
          </tr>
          <tr>
            <td>Otros</td>
            <td>
              <input class="form-control mb-1" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732023NumOtros">
              <input class="form-control" type="text" maxlength="300" placeholder="Especifique"
                     formControlName="p732023NumOtrosDetalle">
            </td>
            <td>
              <input class="form-control mb-1" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732024NumOtros">
              <input class="form-control" type="text" maxlength="300" placeholder="Especifique"
                     formControlName="p732024NumOtrosDetalle">
            </td>
            <td>
              <input class="form-control mb-1" type="number" maxlength="4" (keydown)="permitirSoloNumerosMax4($event)" min="0" formControlName="p732025NumOtros">
              <input class="form-control" type="text" maxlength="300" placeholder="Especifique"
                     formControlName="p732025NumOtrosDetalle">
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <small class="text-muted">Para 2025, consignar información del primer semestre (si aplica).</small>
  </div>

  <mat-divider class="my-3"></mat-divider>

  <!-- 7.4 Matriz necesidades -->
  <div class="q">
    <label class="q-label">7.4. Necesidades de la oficina consular para prestar el servicio de manera idónea</label>
    <div class="text-danger small mt-2" *ngIf="showP74GroupError">
      <mat-icon class="me-1" style="font-size: 16px; vertical-align: middle;">warning</mat-icon>
      Selecciona al menos una opción.
    </div>
    <!-- Cabecera tipo thead (solo >1020px) -->
    <div class="matrix-head thead-colored table-bordered hide-under-1020">
      <div class="mh-col mh-check">Tipo</div>
      <div class="mh-col">Gestiones</div>
      <div class="mh-col">Suficiencia</div>
      <div class="mh-col">Especifique / observaciones</div>
    </div>

    <!-- Filas -->
    <div class="matrix-row table-bordered" *ngFor="let r of p74Rows">
      <div class="row-title show-under-1020">
        {{ pretty(r.check) }}
      </div>

      <!-- Col 1: Check -->
      <div class="cell cell-check col-divider">
        <mat-checkbox
          [checked]="isChecked(r.check)"
          (change)="onCheck(r.check, $event)">
          {{ pretty(r.check) }}
        </mat-checkbox>
      </div>

      <!-- Col 2: Gestiones -->
      <div class="cell cell-gest col-divider">
        <span class="cell-label show-under-1020">Gestiones</span>
        <mat-radio-group [formControlName]="r.gest" class="radio-inline">
          <mat-radio-button value="S">Sí</mat-radio-button>
          <mat-radio-button value="N">No</mat-radio-button>
        </mat-radio-group>
         <mat-error *ngIf="isInvalid(r.gest)">Seleccione una opción.</mat-error>
      </div>

      <!-- Col 3: Suficiencia -->
      <div class="cell cell-suf col-divider">
        <span class="cell-label show-under-1020">Suficiencia</span>
        <mat-radio-group [formControlName]="r.suf" class="radio-inline">
          <mat-radio-button value="S">Suficiente</mat-radio-button>
          <mat-radio-button value="N">Insuficiente</mat-radio-button>
        </mat-radio-group>
         <mat-error *ngIf="isInvalid(r.suf)">Seleccione una opción.</mat-error>
      </div>

      <!-- Col 4: Observaciones -->
      <div class="cell cell-obs">
        <span class="cell-label show-under-1020">Especifique / observaciones</span>


              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Especifique</mat-label>
              <textarea matInput rows="2" maxlength="500" [formControlName]="r.esp" placeholder="Máx. 500 caracteres"></textarea>
              <mat-hint align="end">
                {{ charLen(r.esp) }}/500
              </mat-hint>
              <mat-error>
                <mat-icon fontIcon="warning" class="text-danger me-1" style="font-size: 15px;"></mat-icon>
                Campo requerido
              </mat-error>
            </mat-form-field>

        <mat-form-field *ngIf="r.otroDet" appearance="outline" class="w-100 dense">
          <mat-label>Otro (detalle)</mat-label>
          <input matInput [formControlName]="r.otroDet" maxlength="300" />
        </mat-form-field>
      </div>
    </div>

    <div class="mt-2">
      <mat-checkbox
        [checked]="isChecked('p74Ninguno')"
        (change)="onCheck('p74Ninguno', $event)">
        Ninguno
      </mat-checkbox>
    </div>

     
  </div>

  <mat-divider class="my-3"></mat-divider>

  <!-- 7.5 -->
  <div class="q">
    <label class="q-label">7.5 ¿Recibe el personal consular a cargo de atender este servicio capacitaciones, cursos, entre otros, para realizar dicho servicio, a fin de garantizar una adecuada atención?</label>
    <mat-radio-group formControlName="p75Recibe" class="inline">
      <mat-radio-button value="S">Sí<b style="color:#0094ea;"> → Pase a 7.6</b></mat-radio-button>
      <mat-radio-button value="N">No<b style="color:#0094ea;"> → Pase a la siguiente sección</b></mat-radio-button>
    </mat-radio-group>
    <div class="err" *ngIf="isInvalid('p75Recibe')">Requerido</div>
  </div>

  <!-- 7.6 -->
  <div class="q">
    <label class="q-label">7.6 Indicar la(s) institución(es) del Estado que brinda(n) las capacitaciones</label>
    <div class="row g-2">
      <div class="col-6 col-md-3" *ngFor="let k of p76Instituciones">
        <mat-checkbox
          [disabled]="isDisabled76(k)"
          [checked]="isChecked(k)"
          (change)="onCheck(k, $event)">
          {{ pretty(k) }}
        </mat-checkbox>
      </div>
    </div>

    <div class="row g-2 mt-1">
      <div class="col-12 col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Otro (detalle)</mat-label>
          <input matInput formControlName="p76OtroDetalle" maxlength="500">
        </mat-form-field>
      </div>
 
             <!-- <div class="col-12 col-md-3 d-flex align-items-center">
                  <mat-checkbox
                    [disabled]="!f('p76Ninguna') || f('p75Recibe')?.value !== 'S'"
                    [checked]="isChecked('p76Ninguna')"
                    (change)="onCheck('p76Ninguna', $event)">
                    No ha recibido ninguna
                  </mat-checkbox>
                </div> -->

      <div class="err"
        *ngIf="f('p75Recibe')?.value==='S' && f('p75Recibe')?.errors?.['p76Group']">
        Selecciona al menos una institución.
      </div>
    </div>
  </div>

  <mat-divider class="my-3"></mat-divider>
</section>
  <!-- Acciones -->
  <div class="d-flex justify-content-between align-items-center mt-3 gap-2 flex-wrap">
    <button mat-stroked-button type="button" class="gridSaveItem" (click)="guardarSeccion7Incompleta()">
      Guardado Parcial
    </button>

    <button mat-stroked-button class="gridSaveItemC" type="button" *ngIf="tieneRolEspecialista()"
            (click)="validarSeccion()" [disabled]="ficha7Form.invalid">
      Validar Sección 7
    </button>

    <button mat-flat-button class="gridSaveItemC" type="submit" >
      Guardar sección Completa
    </button>
  </div>
</form>
